name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: rm -rf node_modules package-lock.json && npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run TypeScript type checking
        run: npx tsc --noEmit

      - name: Run ESLint
        run: npm run lint

      - name: Run unit tests
        run: npm test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          JWT_SECRET: test-secret-key-for-ci-only-not-for-production

      - name: Build application for E2E
        run: npm run build:e2e
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          JWT_SECRET: test-secret-key-for-ci-only-not-for-production

      - name: Run E2E tests (production mode)
        run: npm run e2e
        env:
          DATABASE_URL: postgresql://test:test@localhost:5434/test_0
          DATABASE_URL_BASE: postgresql://test:test@localhost:5434
          JWT_SECRET: test-secret-key-for-ci-only-not-for-production

      - name: Merge coverage reports
        run: npm run coverage:merge

      - name: Run E2E tests (dev mode)
        run: npm run e2e:dev
        env:
          DATABASE_URL: postgresql://restaurant_user:restaurant_password@localhost:5433/restaurant_reviews
          JWT_SECRET: test-secret-key-for-ci-only-not-for-production

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          fail_ci_if_error: false

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  deploy-report:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Create gh-pages branch if not exists
        run: |
          if [ ! -d ".git" ]; then
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
            git checkout -b gh-pages
            echo "# Playwright Reports" > index.html
          fi

      - name: Download Playwright report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: temp-report/

      - name: Deploy report to GitHub Pages
        run: |
          # Determine report directory name
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            REPORT_DIR="pr-${{ github.event.pull_request.number }}"
          else
            REPORT_DIR="main-${{ github.sha }}"
          fi

          # Copy report to the directory
          rm -rf "$REPORT_DIR"
          cp -r temp-report/ "$REPORT_DIR"
          rm -rf temp-report/

          # Update index.html with links to all reports
          echo '<!DOCTYPE html><html><head><title>Playwright Reports</title><style>body{font-family:sans-serif;max-width:800px;margin:40px auto;padding:20px}h1{color:#333}ul{list-style:none;padding:0}li{margin:10px 0}a{color:#0066cc;text-decoration:none}a:hover{text-decoration:underline}.date{color:#666;font-size:0.9em}</style></head><body><h1>Playwright Test Reports</h1><ul>' > index.html

          # List all report directories, sorted by modification time (newest first)
          for dir in $(ls -dt pr-* main-* 2>/dev/null | head -20); do
            if [ -d "$dir" ]; then
              echo "<li><a href=\"$dir/index.html\">$dir</a> <span class=\"date\">$(date -r "$dir" '+%Y-%m-%d %H:%M')</span></li>" >> index.html
            fi
          done

          echo '</ul></body></html>' >> index.html

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push
          git add .
          git commit -m "Deploy Playwright report for $REPORT_DIR" || echo "No changes to commit"
          git push origin gh-pages

      - name: Post report URL to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const reportUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/index.html`;
            const coverageUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/e2e-coverage.html`;

            const body = `## ðŸ“Š Test Reports\n\n- [Playwright Report](${reportUrl})\n- [E2E Coverage Report](${coverageUrl})`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ðŸ“Š Test Reports')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
